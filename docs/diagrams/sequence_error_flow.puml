@startuml

title Error Handling Flow - Vehicle Timeout Scenario (I3.T3)

actor Engineer
participant "Web App" as WebApp
participant "API Gateway" as Gateway
participant "Application Server" as AppServer
box "Application Server Components" #LightBlue
  participant "Auth Service" as AuthService
  participant "Command Service" as CommandService
  participant "SOVD Protocol\nHandler" as SOVDHandler
  participant "Vehicle Connector" as VehicleConnector
end box
participant "Database" as DB
participant "Redis\nPub/Sub" as Redis
participant "WebSocket Server" as WSServer
participant "Vehicle" as Vehicle

== Vehicle Timeout Scenario (10% Probability) ==

Engineer -> WebApp : Submits valid command
WebApp -> Gateway : POST /api/v1/commands\n{vehicle_id, command_name: "ReadDTC",\ncommand_params: {"ecuAddress": "0x10"}}
Gateway -> AppServer : POST /commands (with JWT)
AppServer -> CommandService : submit_command()
CommandService -> DB : Validate vehicle exists
DB --> CommandService : Vehicle record
CommandService -> SOVDHandler : validate_command()
SOVDHandler --> CommandService : Valid (OK)
CommandService -> DB : Insert command\n(status='pending')
DB --> CommandService : Command created
CommandService -> VehicleConnector : execute_command()\n(via BackgroundTasks)
activate VehicleConnector
CommandService --> AppServer : Command object
AppServer --> Gateway : 202 Accepted\n{command_id, status: "pending"}
Gateway --> WebApp : Command submitted
WebApp -> Engineer : "Command executing...\n(command_id: {uuid})"

note right of VehicleConnector : Async execution begins.\nMain thread already returned 202.

VehicleConnector -> VehicleConnector : Simulate error roll (random.random())\nIf roll < 0.10: trigger timeout

note right of VehicleConnector : **TIMEOUT SIMULATION (10%)**\n\nConnector simulates timeout:\n1. Sleep for 31 seconds\n2. Raise TimeoutError exception\n\nSimulates real-world scenarios:\n- Network connectivity loss\n- Vehicle powered off\n- ECU not responding

VehicleConnector -> VehicleConnector : await asyncio.sleep(31)\nraise TimeoutError("Vehicle connection timeout")

note right of VehicleConnector : **EXCEPTION HANDLING**\n\nExisting error handler (lines 472-544)\ncatches TimeoutError and executes\ngraceful degradation flow.

VehicleConnector -> DB : Update command\nstatus='failed'\nerror_message="Vehicle connection timeout"\ncompleted_at=now
activate DB
DB --> VehicleConnector : Updated
deactivate DB

VehicleConnector -> Redis : PUBLISH response:{command_id}\n{"event": "error",\n"command_id": "{uuid}",\n"error_message": "Vehicle connection timeout",\n"failed_at": "{iso_timestamp}"}
activate Redis
Redis --> VehicleConnector : Published (error event)
deactivate Redis

VehicleConnector -> DB : Insert audit log\naction='command_failed'\ndetails={"command_name": "ReadDTC",\n"error": "Vehicle connection timeout"}
activate DB
DB --> VehicleConnector : Audit log saved
deactivate DB

deactivate VehicleConnector

note right of VehicleConnector : Background task complete.\nCommand marked as failed.\nError event published to Redis.

== Real-Time Error Notification via WebSocket ==

Redis -> WSServer : Error event received from channel\nresponse:{command_id}
activate WSServer
WSServer -> WSServer : Parse error event JSON
WSServer -> WebApp : WS message: {event: "error",\nerror_message: "Vehicle connection timeout",\nfailed_at: "{timestamp}"}
deactivate WSServer
WebApp -> Engineer : Real-time error notification:\n"Command failed: Vehicle connection timeout"

note right of WSServer : WebSocket server subscribes to\nRedis channel and forwards\nerror events immediately.

== Alternative: Polling-Based Error Detection ==

note right of Engineer : If WebSocket connection is lost,\nuser can still poll for status updates.

Engineer -> WebApp : Checks command status\n(manual refresh or polling)
WebApp -> Gateway : GET /api/v1/commands/{command_id}
Gateway -> AppServer : GET /commands/{command_id}
AppServer -> DB : Query command record
DB --> AppServer : Command\n{status: "failed",\nerror_message: "Vehicle connection timeout"}
AppServer --> Gateway : 200 OK + Command object
Gateway --> WebApp : Command data
WebApp -> Engineer : Display error message:\n"Command failed: Vehicle connection timeout"

note right of Engineer : User actions:\n- Check vehicle connectivity\n- Retry command later\n- Review vehicle logs

== Other Error Scenarios ==

note over VehicleConnector : **Vehicle Unreachable (5%)**\nImmediate ConnectionError\nSame error handling flow

note over VehicleConnector : **Malformed Response (3%)**\nPublish invalid JSON chunk,\nthen ValueError exception.\nSame error handling flow

note over VehicleConnector : All error types result in:\n1. Command status = 'failed'\n2. Error message saved to DB\n3. Error event published to Redis\n4. Audit log entry created

@enduml

@startuml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

LAYOUT_TOP_DOWN()

title Container Diagram - SOVD Command WebApp

Person(engineer, "Automotive Engineer", "Performs vehicle diagnostics")
System_Ext(vehicle, "Connected Vehicle", "SOVD 2.0 endpoint")
System_Ext(idp, "Identity Provider", "OAuth2/OIDC provider")

System_Boundary(sovd_system, "SOVD Command WebApp") {
  Container(web_app, "Web Application", "React 18, TypeScript, MUI", "Provides UI for authentication, vehicle selection, command execution, and response viewing")

  Container(api_gateway, "API Gateway", "Nginx", "Routes requests, terminates TLS, serves static files, load balances")

  Container(app_server, "Application Server", "FastAPI, Python 3.11", "Handles business logic: authentication, command validation, execution orchestration, response handling")

  Container(ws_server, "WebSocket Server", "FastAPI WebSocket", "Manages real-time streaming connections for command responses")

  Container(vehicle_connector, "Vehicle Connector", "Python, gRPC/WebSocket Client", "Abstracts vehicle communication protocols, handles retries, connection pooling")

  ContainerDb(postgres, "Database", "PostgreSQL 15", "Stores vehicles, commands, responses, users, sessions, audit logs")

  ContainerDb(redis, "Cache", "Redis 7", "Caches sessions, vehicle status, recent responses for performance")
}

Rel(engineer, web_app, "Uses", "HTTPS")
Rel(web_app, api_gateway, "Makes API calls", "HTTPS, JSON")
Rel(web_app, ws_server, "Opens WebSocket for streaming", "WSS")

Rel(api_gateway, app_server, "Routes requests to", "HTTP")
Rel(api_gateway, ws_server, "Routes WebSocket upgrade", "WebSocket Protocol")

Rel(app_server, postgres, "Reads/Writes", "SQL (asyncpg)")
Rel(app_server, redis, "Caches data", "Redis Protocol")
Rel(app_server, vehicle_connector, "Requests command execution", "Internal API")
Rel(app_server, idp, "Validates tokens", "OAuth2/OIDC")

Rel(ws_server, postgres, "Reads response data", "SQL (asyncpg)")
Rel(ws_server, redis, "Publishes/Subscribes to response events", "Redis Pub/Sub")

Rel(vehicle_connector, vehicle, "Sends SOVD commands, receives responses", "gRPC/WebSocket over TLS")
Rel(vehicle_connector, redis, "Publishes response events", "Redis Pub/Sub")
Rel(vehicle_connector, postgres, "Writes responses", "SQL (asyncpg)")

@enduml

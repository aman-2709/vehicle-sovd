@startuml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

LAYOUT_WITH_LEGEND()

title Component Diagram - Application Server

Container_Boundary(app_server, "Application Server (FastAPI)") {

  Component(api_router, "API Router", "FastAPI APIRouter", "Top-level request routing and middleware chain")

  Component(auth_controller, "Auth Controller", "FastAPI Router", "Handles /auth/* endpoints: login, logout, refresh token")
  Component(vehicle_controller, "Vehicle Controller", "FastAPI Router", "Handles /vehicles/* endpoints: list, get, status")
  Component(command_controller, "Command Controller", "FastAPI Router", "Handles /commands/* endpoints: execute, history, get response")

  Component(auth_service, "Auth Service", "Python Module", "JWT generation/validation, password hashing, RBAC enforcement")
  Component(vehicle_service, "Vehicle Service", "Python Module", "Vehicle registry, connection status, health checks")
  Component(command_service, "Command Service", "Python Module", "Command validation, execution orchestration, response aggregation")
  Component(audit_service, "Audit Service", "Python Module", "Structured logging, audit trail persistence")

  Component(sovd_handler, "SOVD Protocol Handler", "Python Module", "SOVD 2.0 specification validation, command encoding, response decoding")

  Component(vehicle_repo, "Vehicle Repository", "SQLAlchemy", "Data access for vehicles table")
  Component(command_repo, "Command Repository", "SQLAlchemy", "Data access for commands table")
  Component(response_repo, "Response Repository", "SQLAlchemy", "Data access for responses table")
  Component(user_repo, "User Repository", "SQLAlchemy", "Data access for users table")

  Component(shared_kernel, "Shared Kernel", "Python Modules", "Logging, configuration, error handling, dependency injection")
}

ContainerDb(postgres, "PostgreSQL", "Database")
ContainerDb(redis, "Redis", "Cache")
Container(vehicle_connector, "Vehicle Connector", "gRPC/WebSocket Client")
System_Ext(idp, "Identity Provider", "OAuth2")

Rel(api_router, auth_controller, "Routes /auth/* to")
Rel(api_router, vehicle_controller, "Routes /vehicles/* to")
Rel(api_router, command_controller, "Routes /commands/* to")

Rel(auth_controller, auth_service, "Uses")
Rel(vehicle_controller, vehicle_service, "Uses")
Rel(command_controller, command_service, "Uses")

Rel(auth_service, user_repo, "Uses")
Rel(auth_service, idp, "Validates tokens with", "HTTPS")
Rel(auth_service, audit_service, "Logs auth events to")

Rel(vehicle_service, vehicle_repo, "Uses")
Rel(vehicle_service, redis, "Caches vehicle status in", "Redis Protocol")
Rel(vehicle_service, audit_service, "Logs vehicle events to")

Rel(command_service, command_repo, "Uses")
Rel(command_service, response_repo, "Uses")
Rel(command_service, sovd_handler, "Validates commands with")
Rel(command_service, vehicle_connector, "Executes commands via")
Rel(command_service, audit_service, "Logs command events to")

Rel(vehicle_repo, postgres, "Reads/Writes", "SQL")
Rel(command_repo, postgres, "Reads/Writes", "SQL")
Rel(response_repo, postgres, "Reads/Writes", "SQL")
Rel(user_repo, postgres, "Reads/Writes", "SQL")

Rel(audit_service, postgres, "Writes audit logs to", "SQL")

Rel(auth_service, shared_kernel, "Uses utilities from")
Rel(vehicle_service, shared_kernel, "Uses utilities from")
Rel(command_service, shared_kernel, "Uses utilities from")

@enduml

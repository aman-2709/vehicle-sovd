apiVersion: v1
kind: Secret
metadata:
  name: {{ include "sovd-webapp.fullname" . }}-secrets
  labels:
    {{- include "sovd-webapp.labels" . | nindent 4 }}
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "-8"
type: Opaque
data:
  # IMPORTANT: These are placeholder values for development/testing only
  # In production, use External Secrets Operator to sync from AWS Secrets Manager
  # Example: https://external-secrets.io/latest/provider/aws-secrets-manager/

  # Database password
  # Placeholder: "placeholder" in base64
  # In production: Use External Secrets Operator to fetch from AWS Secrets Manager
  database-password: {{ .Values.secrets.databasePassword | b64enc | quote }}

  # JWT secret for token signing
  # Placeholder: "placeholder-jwt-secret-change-in-production" in base64
  # In production: Use External Secrets Operator to fetch from AWS Secrets Manager
  jwt-secret: {{ .Values.secrets.jwtSecret | b64enc | quote }}

  {{- if .Values.secrets.redisPassword }}
  # Redis password (optional, some Redis setups don't require authentication)
  # In production: Use External Secrets Operator to fetch from AWS Secrets Manager
  redis-password: {{ .Values.secrets.redisPassword | b64enc | quote }}
  {{- end }}

{{- if .Values.externalSecrets.enabled }}
---
# External Secrets Operator configuration for production
# Syncs secrets from AWS Secrets Manager
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "sovd-webapp.fullname" . }}-external-secrets
  labels:
    {{- include "sovd-webapp.labels" . | nindent 4 }}
spec:
  refreshInterval: 5m
  secretStoreRef:
    name: {{ .Values.externalSecrets.secretStoreName | default "aws-secrets-manager" }}
    kind: SecretStore
  target:
    name: {{ include "sovd-webapp.fullname" . }}-secrets
    creationPolicy: Owner
  data:
  - secretKey: database-url
    remoteRef:
      key: {{ .Values.externalSecrets.databaseSecretKey | default "sovd/production/database" }}
      property: DATABASE_URL
  - secretKey: jwt-secret
    remoteRef:
      key: {{ .Values.externalSecrets.jwtSecretKey | default "sovd/production/jwt" }}
      property: JWT_SECRET
  - secretKey: redis-url
    remoteRef:
      key: {{ .Values.externalSecrets.redisSecretKey | default "sovd/production/redis" }}
      property: REDIS_URL
{{- end }}
